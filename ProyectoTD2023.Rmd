---
title: "ProyectoTD2023"
author: "Grupo J"
date: "`r Sys.Date()`"
output:
  html_document:
    echo: yes
    number_sections: yes
    theme: lumen
    toc: yes
  pdf_document:
    toc: yes
    toc_depth: 3
  html_notebook:
    echo: yes
    number_sections: yes
    toc: yes
params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"
subtitle: "Tratamiento de Datos. Grado en Ciencia de Datos- UV"
---

# Introducción

La empresa ACME Monitorización Fetal ha desarrollado un sistema propio que se encarga de almacenar en una tarjeta de memoria SD toda la información que es capturada por un dispositivo de monitorización fetal (cardiotocógrafo) comercial. 

Nuestro trabajo sera decodificar los datos en codigo binario, y una vez obtenidos, los trataremos y analizaremos para asi acabar visualizandolos.

# Importación de librerias

```{r}
library(tidyverse)
```

# Importación de archivos

Lectura Fichero Digital

Primero empezaremos importando el fichero digital. Luego transformaremos los datos a binario para así poder leerlos. Convertimos los datos de fecha y hora en variables separadas. Una vez tenemos todo esto, convertimos los datos en un data frame y los visualizamos para asegurarnos que los tenemos.

```{r}
# lee la cabecera del archivo
ruta_archivo <- "data/0519xxxiii14/06_02_2023/14.20.34/cabecera_FicheroDigital.dat"

ficheroA <- ruta_archivo
f1 <- file(ficheroA, "rb")
datos_binarios <- readBin(f1, "raw", 8)
close(f1)

# Convertir los datos de fecha y hora a variables separadas
fecha <- as.Date(sprintf("%02d-%02d-%02d", as.numeric(datos_binarios[1]), as.numeric(datos_binarios[2]), as.numeric(datos_binarios[3])), format = "%d-%m-%y")
hora <- sprintf("%02d:%02d:%02d", as.numeric(paste0("0x", datos_binarios[4])), as.numeric(paste0("0x", datos_binarios[5])), as.numeric(paste0("0x", datos_binarios[6])))

# Crear un dataframe con los datos
cabecera_dig_df <- data.frame(fecha = fecha,
                       hora = hora,
                       frecuencia_muestreo = as.numeric(paste0("0x", datos_binarios[7])), num_canales = as.numeric(paste0("0x", datos_binarios[8])))

# muestra los datos leídos
cabecera_dig_df
```

```{r}
# carga el archivo
ruta_archivo <- "data/1059xlxveei79_ECGf2/27_09_2022/14.42.29_III_ECGyEXTyRESTO/FicheroDigital.dat"

ficheroB <- ruta_archivo
A <- readBin(ficheroB, "raw", n = file.info(ficheroB)$size, endian = "little")
HR1 <- A[seq(1, length(A[0:30000]), 9)]
HR2 <- A[seq(2, length(A[0:30000]), 9)]
MHR <- A[seq(3, length(A[0:30000]), 9)]
TOCO <- A[seq(4, length(A[0:30000]), 9)]
MSpO2 <- A[seq(5, length(A[0:30000]), 9)]
VCP <- A[seq(6, length(A[0:30000]), 9)]
Psistolica <- A[seq(7, length(A), 9)]
Pdiastolica <- A[seq(8, length(A), 9)]
Pmedia <- A[seq(9, length(A), 9)]

# calcula la media de VCP
mediaVCP <- mean(VCP)

# Convertir los datos a una matriz con 9 columnas (1 para cada canal)
digital <- matrix(as.numeric(A), ncol = 9, byrow = TRUE)

colnames(digital) <- c('HR1','HR2','MHR','TOCO','SPO2','VcP','Psistolica','Pdiastolica','Pmedia')

df_digital <- as.data.frame(digital)
head(df_digital)

# grafica los datos

plot(HR1, type = 'l')
plot(HR2, type = 'l')
plot(MHR, type = 'l')
plot(TOCO, type = 'l')
plot(MSpO2, type = 'l')
plot(VCP, type = 'l')
plot(Psistolica, type = 'l')
plot(Pdiastolica, type = 'l')
plot(Pmedia, type = 'l')

```

Lectura Cabecera Fichero analogico

```{r}
ruta_archivo <- "data/0519xxxiii14/06_02_2023/14.20.34/cabecera_FicheroAnalogico.dat"
# lee la cabecera del archivo
ficheroA <- ruta_archivo
f1 <- file(ficheroA, "rb")

# lee los primeros 7 bytes de la cabecera (fecha y resolución del ADC)
fecha_hora <- readBin(f1, "raw", 7)

# lee los siguientes 3 bytes de la cabecera (valores máximos y mínimos del ADC y frecuencia de muestreo)
B <- readBin(f1, "integer", 3, signed = TRUE)

# cierra el archivo
close(f1)


fecha <- as.Date(sprintf("%02d-%02d-%02d", as.numeric(fecha_hora[1]), as.numeric(fecha_hora[2]), as.numeric(fecha_hora[3])), format = "%d-%m-%y")

hora <- sprintf("%02d:%02d:%02d", as.numeric(paste0("0x", fecha_hora[4])), as.numeric(paste0("0x", fecha_hora[5])), as.numeric(paste0("0x", fecha_hora[6])))

ADC <- B[1]
voltaje <- B[2]
Frecuencia <- B[3]

cabecera_analo_df <- data.frame(fecha, hora, ADC, voltaje, Frecuencia)

# muestra los datos leídos
cabecera_analo_df
```

Lectura fichero analogico

```{r}
ruta_archivo <- "data/0519xxxiii14/06_02_2023/14.20.34/FicheroAnalogico.dat"

ficheroA <- ruta_archivo
f1 <- file(ficheroA, "rb")
A <- readBin(f1, "integer", size = 2, n = file.info(ruta_archivo)$size, signed = TRUE)
close(f1)

Fm <- 1000
t <- seq(0, (length(A)-1)/Fm, 1/Fm)
vmax <- max(A)

# tiempo de registro
hora <- ((length(A)/Fm)/60)/60
min <- ((hora - floor(hora)) * 60)
seg <- ((min - floor(min)) * 60)

analogico <- data.frame(A, t)
# texto informativo
cat(sprintf("Tiempo de registro: %d horas, %d minutos y %d segundos\n", floor(hora), floor(min), floor(seg)))
cat(sprintf("Frecuencia de muestreo: %i Hz\n", Fm))
cat(sprintf("Voltaje máximo: %d miliVoltios\n", vmax))

redanalogicos <- subset(analogico, t > max(t)-2)

ggplot(redanalogicos, aes(x=t, y=A)) + geom_line()

```
